kind: pipeline
type: docker
name: build images

steps:
  - name: build php
    image: plugins/ecr
    settings:
      mirror:
        from_secret: docker_proxy_mirror
      purge: true
      tags:
        - latest
        - ${DRONE_COMMIT}
      registry:
        from_secret: ecr_registry
      repo:
        from_secret: ecr_url_php
      dockerfile: Dockerfile-php-base
      access_key:
        from_secret: aws_access_key
      secret_key:
        from_secret: aws_access_key_secret
      region: eu-west-1
    depends_on: [clone]

  - name: build nginx
    image: plugins/ecr
    settings:
      mirror:
        from_secret: docker_proxy_mirror
      purge: true
      tags:
        - latest
        - ${DRONE_COMMIT}
      registry:
        from_secret: ecr_registry
      repo:
        from_secret: ecr_url_nginx
      dockerfile: Dockerfile-nginx-base
      access_key:
        from_secret: aws_access_key
      secret_key:
        from_secret: aws_access_key_secret
      region: eu-west-1
    depends_on: [clone]

  - name: build tagger
    image: plugins/ecr
    settings:
      mirror:
        from_secret: docker_proxy_mirror
      purge: true
      tags:
        - latest
        - ${DRONE_COMMIT}
      registry:
        from_secret: ecr_registry
      repo:
        from_secret: ecr_url_drone-tagger
      dockerfile: drone-tag/Dockerfile-drone-tag
      access_key:
        from_secret: aws_access_key
      secret_key:
        from_secret: aws_access_key_secret
      region: eu-west-1
      context: drone-tag
    depends_on: [clone]

  - name: build param checker
    image: plugins/ecr
    settings:
      mirror:
        from_secret: docker_proxy_mirror
      purge: true
      tags:
        - latest
        - ${DRONE_COMMIT}
      registry:
        from_secret: ecr_registry
      repo:
        from_secret: ecr_url_drone-param-check
      dockerfile: drone-parameters-test/Dockerfile-drone-check-parameters
      access_key:
        from_secret: aws_access_key
      secret_key:
        from_secret: aws_access_key_secret
      region: eu-west-1
      context: drone-param-check
    depends_on: [clone]

trigger:
  repo:
    - BerlingskeMedia/ci.images
  event:
    include:
      - push
      - cron
    exclude:
      - pull_request
  branch:
    - master

---
kind: "secret"
name: "aws_access_key"
get:
  path: "drone/ci-production-images"
  name: "aws_access_key"

---
kind: "secret"
name: "aws_access_key_secret"
get:
  path: "drone/ci-production-images"
  name: "aws_access_key_secret"

---
kind: "secret"
name: "aws_access_key_secret"
get:
  path: "drone/ci-production-images"
  name: "aws_access_key_secret"

---

kind: "secret"
name: "ecr_registry"
get:
  path: "drone/ci-production-images"
  name: "ecr_registry"
---

kind: "secret"
name: "ecr_url_drone-param-check"
get:
  path: "drone/ci-production-images"
  name: "ecr_url_drone-param-check"
---

kind: "secret"
name: "ecr_url_drone-tagger"
get:
  path: "drone/ci-production-images"
  name: "ecr_url_drone-tagger"
---

kind: "secret"
name: "ecr_url_nginx"
get:
  path: "drone/ci-production-images"
  name: "ecr_url_nginx"
---

kind: "secret"
name: "ecr_url_php"
get:
  path: "drone/ci-production-images"
  name: "ecr_url_php"
